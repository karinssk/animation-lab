{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/garin/OneDrive/Desktop/Projects/animation/app/api/places/search/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\n\nconst API_KEY = process.env.GOOGLE_PLACE_API_KEY!;\nconst BASE = \"https://maps.googleapis.com/maps/api/place\";\n\nconst ALLOWED_TYPES = new Set([\n  \"restaurant\", \"cafe\", \"bar\", \"bakery\",\n  \"meal_delivery\", \"meal_takeaway\", \"night_club\",\n]);\n\ninterface SearchBody {\n  query?: string;\n  location?: { lat: number; lng: number };\n  radius?: number;\n  type?: string;\n  pageToken?: string;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body: SearchBody = await request.json();\n    const {\n      query = \"restaurant\",\n      location,\n      radius = 5000,\n      type,\n      pageToken,\n    } = body;\n\n    const safeQuery = (query || \"restaurant\").slice(0, 200);\n    const safeRadius = Math.min(Math.max(Number(radius) || 5000, 100), 50000);\n    const safeType = type && ALLOWED_TYPES.has(type) ? type : undefined;\n\n    // ALWAYS use Text Search for better natural language understanding (\"vibe search\")\n    // Nearby Search is too strict with keywords.\n    const params = new URLSearchParams({\n      query: safeQuery,\n      key: API_KEY,\n      language: \"th\",\n    });\n\n    if (location) {\n      params.set(\"location\", `${location.lat},${location.lng}`);\n      params.set(\"radius\", String(safeRadius));\n    }\n\n    if (safeType) params.set(\"type\", safeType);\n    if (pageToken) params.set(\"pagetoken\", pageToken);\n\n    const url = `${BASE}/textsearch/json?${params}`;\n\n    const res = await fetch(url);\n    const data = await res.json();\n\n    if (data.status === \"REQUEST_DENIED\" || data.status === \"OVER_QUERY_LIMIT\") {\n      console.error(\"âŒ Google Search API Error:\", JSON.stringify(data, null, 2));\n      return NextResponse.json(\n        { results: [], nextPageToken: null, status: data.status, error: data.error_message },\n        { status: 429 }\n      );\n    }\n\n    /* eslint-disable @typescript-eslint/no-explicit-any */\n    const results = (data.results || []).map((r: any) => ({\n      placeId: r.place_id,\n      name: r.name,\n      address: r.formatted_address || r.vicinity || \"\",\n      location: r.geometry?.location || { lat: 0, lng: 0 },\n      rating: r.rating ?? null,\n      userRatingsTotal: r.user_ratings_total ?? 0,\n      types: r.types || [],\n      priceLevel: r.price_level ?? null,\n      openNow: r.opening_hours?.open_now ?? null,\n      photos: (r.photos || []).slice(0, 10).map((p: any) => ({\n        photoReference: p.photo_reference,\n        width: p.width,\n        height: p.height,\n      })),\n    }));\n\n    return NextResponse.json({\n      results,\n      nextPageToken: data.next_page_token || null,\n      status: data.status,\n    });\n  } catch (err) {\n    console.error(\"Places search error:\", err);\n    return NextResponse.json(\n      { results: [], nextPageToken: null, status: \"ERROR\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,UAAU,QAAQ,GAAG,CAAC,oBAAoB;AAChD,MAAM,OAAO;AAEb,MAAM,gBAAgB,IAAI,IAAI;IAC5B;IAAc;IAAQ;IAAO;IAC7B;IAAiB;IAAiB;CACnC;AAUM,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAmB,MAAM,QAAQ,IAAI;QAC3C,MAAM,EACJ,QAAQ,YAAY,EACpB,QAAQ,EACR,SAAS,IAAI,EACb,IAAI,EACJ,SAAS,EACV,GAAG;QAEJ,MAAM,YAAY,CAAC,SAAS,YAAY,EAAE,KAAK,CAAC,GAAG;QACnD,MAAM,aAAa,KAAK,GAAG,CAAC,KAAK,GAAG,CAAC,OAAO,WAAW,MAAM,MAAM;QACnE,MAAM,WAAW,QAAQ,cAAc,GAAG,CAAC,QAAQ,OAAO;QAE1D,mFAAmF;QACnF,6CAA6C;QAC7C,MAAM,SAAS,IAAI,gBAAgB;YACjC,OAAO;YACP,KAAK;YACL,UAAU;QACZ;QAEA,IAAI,UAAU;YACZ,OAAO,GAAG,CAAC,YAAY,GAAG,SAAS,GAAG,CAAC,CAAC,EAAE,SAAS,GAAG,EAAE;YACxD,OAAO,GAAG,CAAC,UAAU,OAAO;QAC9B;QAEA,IAAI,UAAU,OAAO,GAAG,CAAC,QAAQ;QACjC,IAAI,WAAW,OAAO,GAAG,CAAC,aAAa;QAEvC,MAAM,MAAM,GAAG,KAAK,iBAAiB,EAAE,QAAQ;QAE/C,MAAM,MAAM,MAAM,MAAM;QACxB,MAAM,OAAO,MAAM,IAAI,IAAI;QAE3B,IAAI,KAAK,MAAM,KAAK,oBAAoB,KAAK,MAAM,KAAK,oBAAoB;YAC1E,QAAQ,KAAK,CAAC,8BAA8B,KAAK,SAAS,CAAC,MAAM,MAAM;YACvE,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS,EAAE;gBAAE,eAAe;gBAAM,QAAQ,KAAK,MAAM;gBAAE,OAAO,KAAK,aAAa;YAAC,GACnF;gBAAE,QAAQ;YAAI;QAElB;QAEA,qDAAqD,GACrD,MAAM,UAAU,CAAC,KAAK,OAAO,IAAI,EAAE,EAAE,GAAG,CAAC,CAAC,IAAW,CAAC;gBACpD,SAAS,EAAE,QAAQ;gBACnB,MAAM,EAAE,IAAI;gBACZ,SAAS,EAAE,iBAAiB,IAAI,EAAE,QAAQ,IAAI;gBAC9C,UAAU,EAAE,QAAQ,EAAE,YAAY;oBAAE,KAAK;oBAAG,KAAK;gBAAE;gBACnD,QAAQ,EAAE,MAAM,IAAI;gBACpB,kBAAkB,EAAE,kBAAkB,IAAI;gBAC1C,OAAO,EAAE,KAAK,IAAI,EAAE;gBACpB,YAAY,EAAE,WAAW,IAAI;gBAC7B,SAAS,EAAE,aAAa,EAAE,YAAY;gBACtC,QAAQ,CAAC,EAAE,MAAM,IAAI,EAAE,EAAE,KAAK,CAAC,GAAG,IAAI,GAAG,CAAC,CAAC,IAAW,CAAC;wBACrD,gBAAgB,EAAE,eAAe;wBACjC,OAAO,EAAE,KAAK;wBACd,QAAQ,EAAE,MAAM;oBAClB,CAAC;YACH,CAAC;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB;YACA,eAAe,KAAK,eAAe,IAAI;YACvC,QAAQ,KAAK,MAAM;QACrB;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS,EAAE;YAAE,eAAe;YAAM,QAAQ;QAAQ,GACpD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}